<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{main/base}">

<head>
	<title>질문 보기</title>
	<style>
		.container {
			width: 80%;
			margin: 20px auto;
		}

		.hidden {
			display: none !important;
		}

		/* 모달 스타일 */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.modal-content {
			background: white;
			padding: 30px;
			border-radius: 8px;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
			text-align: center;
			min-width: 300px;
		}

		.modal-content input {
			width: calc(100% - 22px);
			padding: 10px;
			margin: 10px 0 20px 0;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		.modal-content button {
			padding: 10px 20px;
			cursor: pointer;
		}

		/* 질문 본문 스타일 */
		.question-area {
			border: 1px solid #ddd;
			padding: 30px;
			border-radius: 8px;
		}

		.question-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 1px solid #eee;
			padding-bottom: 15px;
			margin-bottom: 20px;
		}

		.question-title {
			font-size: 24px;
			font-weight: bold;
			margin: 0;
		}

		.question-meta {
			text-align: right;
		}

		.question-meta span,
		.answer-item span {
			display: block;
			font-size: 14px;
			color: #888;
			width: 140px;
		}

		.question-status {
			font-weight: bold;
		}

		.question-content {
			min-height: 150px;
			padding: 20px 0;
			font-size: 16px;
			line-height: 1.6;
			white-space: pre-wrap;
		}

		/* pre-wrap으로 줄바꿈 유지 */

		#edit-form {
			margin-top: 40px;
		}

		/* 수정 모드 스타일 */
		#edit-form input,
		#edit-form textarea {
			width: calc(100% - 22px);
			padding: 10px;
			font-size: 16px;
		}

		#edit-form textarea {
			height: 150px;
			resize: vertical;
			margin: 20px 0;
		}

		.edit-password-group {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		/* 버튼 컨테이너 */
		.button-container {
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			margin-top: 20px;
		}

		.button-container button {
			padding: 8px 16px;
			cursor: pointer;
		}

		.list-btn {
			padding: 8px 16px;
			border-radius: 5px;
			cursor: pointer;
		}

		/* 답변 영역 스타일 */
		.answers-section {
			margin-top: 40px;
		}

		.answer-item {
			background-color: #f9f9f9;
			border: 1px solid #e9e9e9;
			border-radius: 5px;
			padding: 15px;
			margin-bottom: 10px;
			display: flex;
			justify-content: space-between;
		}

		.answer-item p {
			margin: 0;
		}

		.answer-content {
			white-space: pre-wrap;
			margin: 0;
		}

		.answer-meta {
			text-align: right;
			font-size: 13px;
			color: #6c757d;
			margin-left: 20px;
			flex-shrink: 0;
		}

		.answer-meta span {
			display: block;
		}

		#view-mode {
			margin-top: 40px;
		}

		.password-confirm-button-div {
			display: flex;
			justify-content: space-between;
		}
	</style>
</head>

<main layout:fragment="content">
	<div class="container">
		<!-- 비밀번호 입력 모달 -->
		<div id="password-modal" class="modal-overlay">
			<div class="modal-content">
				<h3>비밀번호 입력</h3>
				<p>질문 내용을 보려면 비밀번호를 입력하세요.</p>
				<form id="password-form">
					<input type="password" name="boardPassword" id="password-input" placeholder="비밀번호 4자리" maxlength="4"
						required autocomplete="one-time-code" inputmode="numeric">
					<div class="password-confirm-button-div">
						<a href="/question" class="btn btn-secondary list-btn"
							style="text-decoration: none; width: calc(35%); display: inline-block;">돌아가기</a>
						<button type="submit" class="btn btn-primary-mini" style="width: calc(48%);">확인</button>
					</div>
				</form>
			</div>
		</div>

		<!-- 삭제 확인 모달 -->
		<div id="delete-modal" class="modal-overlay hidden">
			<div class="modal-content">
				<h3>질문 삭제</h3>
				<p>삭제하시려면 비밀번호를 입력하세요.</p>
				<form id="delete-form">
					<input type="password" name="boardPassword" id="delete-password-input" placeholder="비밀번호 4자리"
						maxlength="4" required autocomplete="one-time-code" inputmode="numeric">
					<div class="button-container">
						<button type="button" class="btn btn-secondary" id="cancel-delete-btn">취소</button>
						<button type="submit" class="btn btn-primary-mini">삭제 확인</button>
					</div>
				</form>
			</div>
		</div>

		<!-- 질문 내용이 표시될 영역 -->
		<div id="question-area" class="question-area hidden" th:attr="data-question-id=${questionId}">
			<a href="/question" class="btn btn-primary-mini list-btn" style="text-decoration: none;">목록</a>
			<!-- 조회 모드 -->
			<div id="view-mode">
				<div>
				</div>
				<div class="question-header">
					<h2 id="question-title" class="question-title"></h2>
					<div class="question-meta">
						<span id="question-id" class="question-id"></span>
						<span id="question-status" class="question-status"></span>
						<span id="question-createdAt"></span>
						<span id="question-updatedAt"></span>
					</div>
				</div>
				<div id="question-content" class="question-content"></div>
			</div>

			<!-- 수정 모드 -->
			<form id="edit-form" class="hidden">
				<input type="text" id="edit-title" required>
				<textarea id="edit-content" required></textarea>
				<div class="edit-password-group">
					<label for="edit-password" style="width: 70px;">비밀번호:</label>
					<input type="password" name="boardPassword" id="edit-password" placeholder="수정 확인용 비밀번호"
						maxlength="4" required autocomplete="one-time-code" inputmode="numeric">
				</div>
			</form>

			<!-- 버튼 영역 -->
			<div class="button-container">
				<button id="edit-btn" class="btn btn-secondary">수정</button>
				<button id="delete-btn" class="btn btn-secondary btn-danger">삭제</button>
				<button id="cancel-edit-btn" class="btn btn-secondary hidden">취소</button>
				<button id="save-btn" class="btn btn-primary-mini hidden">저장</button>
			</div>
		</div>

		<!-- 답변 표시 영역 -->
		<div id="answers-section" class="answers-section hidden">
			<h3>답변</h3>
			<div id="answers-container"></div>
		</div>
	</div>
</main>

<th:block layout:fragment="script">
	<script type="module">
		import {verifyPassword, modifyQuestion, deleteQuestion} from '/js/question.js';
		import {initQuestionPasswordFormatting} from '/js/format.js';

		// --- 상태 관리 ---
		let currentQuestionData = null; // 원본 질문 데이터 저장 (version 포함)

		// --- DOM 요소 ---
		const passwordModal = document.getElementById('password-modal');
		const deleteModal = document.getElementById('delete-modal');
		const questionArea = document.getElementById('question-area');
		const answersSection = document.getElementById('answers-section');
		const questionId = questionArea.dataset.questionId;

		// 조회/수정 모드 관련 요소
		const viewMode = document.getElementById('view-mode');
		const editForm = document.getElementById('edit-form');
		const editBtn = document.getElementById('edit-btn');
		const saveBtn = document.getElementById('save-btn');
		const cancelEditBtn = document.getElementById('cancel-edit-btn');
		const deleteBtn = document.getElementById('delete-btn');

		initQuestionPasswordFormatting(document.getElementById('edit-password'));
		initQuestionPasswordFormatting(document.getElementById('delete-password-input'));

		// --- 렌더링 함수 ---
		const renderQuestion = (data) => {
			currentQuestionData = data; // 데이터와 version 저장

			// 상태 맵
			const statusMap = {'PENDING': '답변 대기 중', 'ANSWER': '답변 완료'};

			// 조회 모드 데이터 채우기
			document.getElementById('question-id').textContent = `질문 번호: ${data.questionId}`;
			document.getElementById('question-title').textContent = data.title;
			document.getElementById('question-status').textContent = statusMap[data.questionStatus] || '';
			document.getElementById('question-createdAt').textContent = `작성일: ${new Date(data.createdAt).toLocaleDateString()}`;
			const updatedAtValue = data.updatedAt;
			document.getElementById('question-updatedAt').textContent = updatedAtValue ? `수정일: ${new Date(data.updatedAt).toLocaleDateString()}` : '';
			document.getElementById('question-content').textContent = data.content;

			// 수정 모드 폼 채우기
			document.getElementById('edit-title').value = data.title;
			document.getElementById('edit-content').value = data.content;

			// 답변 렌더링
			const answersContainer = document.getElementById('answers-container');
			answersContainer.innerHTML = '';
			if (data.answers && data.answers.length > 0) {
				answersSection.classList.remove('hidden');
				data.answers.forEach(answer => {
					const answerEl = document.createElement('div');
					answerEl.className = 'answer-item';
					answerEl.dataset.answerId = answer.answerId;
					answerEl.innerHTML = `
									<div class="answer-body">
										<p class="answer-content">${answer.content}</p>
									</div>
									<div class="answer-meta">
										<span>작성일: ${new Date(answer.createdAt).toLocaleDateString()}</span>
									</div>
								`;
					answersContainer.appendChild(answerEl);
				});
			} else {
				answersSection.classList.add('hidden');
			}
		};

		// --- UI 모드 전환 함수 ---
		const toggleEditMode = (isEditing) => {
			viewMode.classList.toggle('hidden', isEditing);
			editForm.classList.toggle('hidden', !isEditing);

			editBtn.classList.toggle('hidden', isEditing);
			deleteBtn.classList.toggle('hidden', isEditing);
			saveBtn.classList.toggle('hidden', !isEditing);
			cancelEditBtn.classList.toggle('hidden', !isEditing);
		};

		// --- 이벤트 핸들러 ---
		// 1. 초기 비밀번호 확인
		document.getElementById('password-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const password = document.getElementById('password-input').value;
			if (!password) return alert('비밀번호를 입력하세요.');

			try {
				const data = await verifyPassword(questionId, password);
				passwordModal.classList.add('hidden');
				questionArea.classList.remove('hidden');
				renderQuestion(data);
			} catch (error) {
				document.getElementById('password-input').value = '';
			}
		});

		// 2. 수정 버튼 클릭
		editBtn.addEventListener('click', () => toggleEditMode(true));

		// 3. 수정 취소 버튼 클릭
		cancelEditBtn.addEventListener('click', () => {
			// 원본 데이터로 폼 복원
			document.getElementById('edit-title').value = currentQuestionData.title;
			document.getElementById('edit-content').value = currentQuestionData.content;
			toggleEditMode(false);
		});

		// 4. 저장 버튼 클릭 (수정 완료)
		saveBtn.addEventListener('click', async (e) => {
			e.preventDefault();
			const password = document.getElementById('edit-password').value;
			if (!password) return alert('수정 확인을 위해 비밀번호를 입력하세요.');

			const modifyData = {
				title: document.getElementById('edit-title').value,
				content: document.getElementById('edit-content').value,
				password: password,
				version: currentQuestionData.version
			};

			try {
				const updatedData = await modifyQuestion(questionId, modifyData);
				alert('수정되었습니다.');
				renderQuestion(updatedData); // 서버로부터 받은 최신 데이터로 화면 갱신
				toggleEditMode(false); // 조회 모드로 전환
				document.getElementById('edit-password').value = ''; // 비밀번호 필드 비우기
			} catch (error) {
				// 버전 충돌 등의 에러 메시지는 fetchApi에서 alert로 처리됨
			}
		});

		// 5. 삭제 버튼 클릭
		deleteBtn.addEventListener('click', () => deleteModal.classList.remove('hidden'));

		// 6. 삭제 취소
		document.getElementById('cancel-delete-btn').addEventListener('click', () => {
			deleteModal.classList.add('hidden');
			document.getElementById('delete-password-input').value = '';
		});

		// 7. 최종 삭제 확인
		document.getElementById('delete-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const password = document.getElementById('delete-password-input').value;
			if (!password) return alert('삭제 확인을 위해 비밀번호를 입력하세요.');

			try {
				await deleteQuestion(questionId, password, currentQuestionData.version);
				alert('삭제되었습니다.');
				location.href = '/question'; // 목록으로 이동
			} catch (error) {
				document.getElementById('delete-password-input').value = '';
			}
		});

	</script>
</th:block>

</html>